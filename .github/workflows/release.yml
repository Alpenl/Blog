name: è‡ªåŠ¨éƒ¨ç½²VitePressç«™ç‚¹åˆ°GitHub Pages

on:
  push:
    branches: [main]  # è§¦å‘éƒ¨ç½²çš„åˆ†æ”¯
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-and-deploy:
    name: ğŸš€ æ„å»ºä¸éƒ¨ç½²
    runs-on: ubuntu-latest
    steps:
      # --------------------------
      # ä»£ç æ£€å‡ºä¸ç¯å¢ƒå‡†å¤‡
      # --------------------------
      - name: æ£€å‡ºä»£ç ä»“åº“ âœ”ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

      - name: å®‰è£…Node.jsç¯å¢ƒ âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: 20  # æŒ‡å®šNode.jsç‰ˆæœ¬

      - name: é…ç½®pnpmåŒ…ç®¡ç†å™¨ ğŸ“¦
        uses: pnpm/action-setup@v2
        with:
          version: latest  # ä½¿ç”¨æœ€æ–°ç‰ˆpnpm

      # --------------------------
      # ä¾èµ–ç¼“å­˜ä¼˜åŒ–
      # --------------------------
      - name: è·å–pnpmå­˜å‚¨ç›®å½•ä½ç½® ğŸ”
        shell: bash
        run: |
          # è·å–pnpm storeè·¯å¾„ä¾›åç»­ç¼“å­˜ä½¿ç”¨
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ç¼“å­˜pnpmä¾èµ–ç›®å½• ğŸ“¦
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}  # ç¼“å­˜pnpmå­˜å‚¨ç›®å½•
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}  # æ ¹æ®lockæ–‡ä»¶ç”Ÿæˆå”¯ä¸€key
          restore-keys: |
            ${{ runner.os }}-pnpm-store-  # å›é€€åŒ¹é…ç­–ç•¥

      - name: ç¼“å­˜VitePressæ„å»ºç¼“å­˜ ğŸ“¦
        uses: actions/cache@v3
        with:
          path: |
            docs/.vitepress/.cache  # VitePressç¼“å­˜ç›®å½•
            docs/.vitepress/dist     # æ„å»ºè¾“å‡ºç›®å½•
          key: ${{ runner.os }}-vitepress-${{ github.sha }}  # æ ¹æ®æäº¤SHAç”Ÿæˆkey
          restore-keys: |
            ${{ runner.os }}-vitepress-  # å›é€€åŒ¹é…ç­–ç•¥

      # --------------------------
      # æ„å»ºä¸éƒ¨ç½²æµç¨‹
      # --------------------------
      - name: å®‰è£…é¡¹ç›®ä¾èµ– ğŸ”§
        run: pnpm install  # å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹

      - name: æ„å»ºVitePressé¡¹ç›® ğŸ› ï¸
        run: pnpm run docs:build  # æ‰§è¡Œæ„å»ºå‘½ä»¤

      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯ âš™ï¸
        run: |
          # è®¾ç½®è‡ªåŠ¨éƒ¨ç½²ä½¿ç”¨çš„Gitç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: éƒ¨ç½²åˆ°GitHub Pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          repository-name: Alpenl/Alpenl.github.io  # ç›®æ ‡ä»“åº“
          branch: main          # éƒ¨ç½²åˆ†æ”¯
          folder: docs/.vitepress/dist  # è¦éƒ¨ç½²çš„æ„å»ºç›®å½•
          token: ${{ secrets.DEPLOY_TOKEN }}  # éƒ¨ç½²ç”¨è®¿é—®ä»¤ç‰Œ